name: TESTING

on:
    push:
      branches: [ staging ]
      paths: [ terraform/** ]
    pull_request:
      branches: [ staging ]
      paths: [ terraform/** ]
      
jobs:
  test:
    runs-on: ubuntu-latest

    steps:     
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      # - name: Checkout Repository
      #   run: git fetch --no-tags --prune --depth=1 origin +refs/heads/*:refs/remotes/origin/*
        
      - name: config aws
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.GHUB_ACTIONS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.GHUB_ACTIONS_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify S3 File
        run: |
          aws s3api head-object --bucket jeremy-code-deploy-dev-useast1 --key api/v2.0.0/api.zip
          
      - name: Setup GitHub CLI
        run: |
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
  
      - name: Create Pull Request
        run: |
          PR_EXIST=$(gh pr list --base main --head staging | wc -l)
          if [ "$PR_EXIST" -eq "0" ]; then
            gh pr create --base main --head staging --title "Staging Terraform Plan & Apply" --body "Automatic PR created by TESTING workflow"
          fi